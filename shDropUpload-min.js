/*!
 * jQuery shDropUpload v1.2
 * http://jquery.sunhater.com/shDropUpload
 * 2014-08-12
 *
 * Copyright (c) 2014 Pavel Tzonkov <sunhater@sunhater.com>
 * Dual licensed under the MIT and GPL licenses.
 */
(function(a){a.fn.shDropUpload=function(e,b){if((typeof XMLHttpRequest=="undefined")||(typeof document.addEventListener=="undefined")||(typeof File=="undefined")||(typeof FileReader=="undefined")){return}var c={url:"",param:"upload",maxFilesize:10485760,precheck:function(g){console.log("shDropUpload: Upload process started");return true},begin:function(i,h,g){console.log("shDropUpload:     Uploading file "+h+" of "+g+" ("+i.file.name+")")},success:function(i,h,g){console.log("shDropUpload:     Upload success ("+i.file.name+")")},error:function(i,h,g){console.log("shDropUpload:     Upload request failed ("+i.file.name+")")},abort:function(i,h,g){console.log("shDropUpload:     Upload request aborted ("+i.file.name+")")},filesizeCallback:function(i,h,g){console.log("shDropUpload:     File is too big ("+i.file.name+")")},finish:function(){console.log("shDropUpload: Upload process finished")}},d={selectors:"img[src]",unique:true,ajax:{url:"",type:"post",dataType:"json",data:{url:"{url}",type:"{type}"},success:function(g){console.log("shDropUpload: URL has been passed to the server.")},error:function(){console.log("shDropUpload: Request failed!")}}},f=function(h){h=h.replace(/\r\n/g,"\n");var j,g="";for(var i=0;i<h.length;i++){j=h.charCodeAt(i);if(j<128){g+=String.fromCharCode(j)}else{if((j>127)&&(j<2048)){g+=String.fromCharCode((j>>6)|192);g+=String.fromCharCode((j&63)|128)}else{g+=String.fromCharCode((j>>12)|224);g+=String.fromCharCode(((j>>6)&63)|128);g+=String.fromCharCode((j&63)|128)}}}return g};a.extend(true,d,b);a.extend(true,c,e);if(!XMLHttpRequest.prototype.sendAsBinary){XMLHttpRequest.prototype.sendAsBinary=function(h){var i=Array.prototype.map.call(h,function(j){return j.charCodeAt(0)&255}),g=new Uint8Array(i);this.send(g)}}a(this).each(function(){var r=this,q=[],g=false,m=0,j="------multipartdropuploadboundary"+new Date().getTime(),i,o=function(s){if(s.preventDefault){s.preventDefault()}a(r).addClass("drag");return false},l=function(s){if(s.preventDefault){s.preventDefault()}return false},n=function(s){if(s.preventDefault){s.preventDefault()}a(r).removeClass("drag");return false},k=function(z){if(z.preventDefault){z.preventDefault()}if(z.stopPropagation){z.stopPropagation()}a(r).removeClass("drag");try{var w=z.dataTransfer.getData("text/html")}catch(z){var w=false}if(w){if(!b){return false}w="<div>"+w.toString()+"</div>";var y=[],v=[];var u=a.isArray(d.selectors)?d.selectors:d.selectors.split(/\s*,\s*/g);a.each(u,function(C,B){if(!/^[a-z0-9]+\[[a-z]+\]$/gi.test(B)){return true}var D=B.split("[")[0],A=B.split("[")[1].split("]")[0];a(w).find(B).each(function(){var E=a(this).attr(A);if(d.unique){for(var F=0;F<y.length;F++){if((y[F]==E)&&(v[F]==D)){return true}}}y.push(E);v.push(D)})});if(!y.length){return false}if(y.length==1){y=y[0];v=v[0]}var x=a.extend(true,{},d.ajax);if(x.data){a.each(x.data,function(B,A){if(A=="{url}"){x.data[B]=y}if(A=="{type}"){x.data[B]=v}})}a.ajax(x)}else{if(!e){return false}m+=z.dataTransfer.files.length;if(!m||!c.precheck(z)){return false}for(var t=0;t<m;t++){var s=z.dataTransfer.files[t];q.push(s)}h()}return false},h=function(){if(g){return false}if(q&&q.length){var u=q.shift(),v=m-q.length,s=new FileReader(),w=(typeof s.readAsBinaryString=="undefined");i=s.file=u;s.onerror=function(x){x.file=u;c.error(x,v,m);h()};s.onload=function(y){g=true;var B=new XMLHttpRequest(),A="--"+j+'\r\nContent-Disposition: form-data; name="'+c.param+'"';B.file=y.target.file;c.begin(B,v,m);if(c.maxFilesize&&(B.file.size>c.maxFilesize)){g=false;c.filesizeCallback(B,v,m);h();return}if(w){var C="",x=new Uint8Array(y.target.result);for(var z=0;z<x.byteLength;z++){C+=String.fromCharCode(x[z])}}if(B.file.name){A+='; filename="'+f(B.file.name)+'"'}A+="\r\n";if(B.file.size){A+="Content-Length: "+B.file.size+"\r\n"}A+="Content-Type: "+B.file.type+"\r\n\r\n"+(w?C:y.target.result)+"\r\n--"+j+"--\r\n";B.open("post",c.url,true);B.setRequestHeader("Content-Type","multipart/form-data; boundary="+j);B.onload=function(){g=false;c.success(B,v,m);h()};B.onerror=function(){g=false;c.error(B,v,m);h()};B.onabort=function(){g=false;c.abort(B,v,m);h()};B.sendAsBinary(A)};if(w){s.readAsArrayBuffer(u)}else{s.readAsBinaryString(u)}}else{m=0;var t=setInterval(function(){if(g){return}j="------multipartdropuploadboundary"+new Date().getTime();q=[];clearInterval(t);c.finish()},333)}};if(!a(r).data("shdu")){a(r).data("shdu",{dragover:o,dragenter:l,dragLeave:n,drop:k})}var p=function(t,v){r.removeEventListener(t,a(r).data("shdu")[t],false);var u=a(r).data("shdu"),s={};s[t]=v;a.extend(u,s);a(r).data("shdu",u);r.addEventListener(t,v,false)};p("dragover",o);p("dragenter",l);p("dragleave",n);p("drop",k)})}})(jQuery);